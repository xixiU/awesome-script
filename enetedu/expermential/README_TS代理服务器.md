# TS 代理服务器使用说明

## 简介

为了显著降低网络流量消耗，本脚本将视频 `.ts` 文件请求重定向到本地 Flask 代理服务器，所有的 TS 文件都返回同一个固定的示例文件，从而避免下载大量实际视频数据。

## 特性

- **大幅降低流量**: 所有 `.ts` 视频片段请求都返回固定的 1 秒短视频，流量节省 99% 以上
- **本地代理**: 使用 Flask 本地服务器，响应速度快
- **真实 TS 文件**: 使用真实的 1 秒 TS 视频片段，完美兼容 HLS 播放器
- **智能适配**: 自动解析时间片段信息，模拟正常的视频播放流程
- **简单易用**: 一键启动，无需复杂配置

## 安装步骤

### 1. 安装 Python 依赖

```bash
cd enetedu
pip install -r requirements.txt
```

### 2. 启动 TS 代理服务器

```bash
python ts_proxy_server.py
```

启动成功后会看到如下输出：

```
TS 文件已找到: /path/to/example.ts
文件大小: 818552 字节

=== TS 代理服务器启动 ===
监听地址: http://127.0.0.1:8888
按 Ctrl+C 停止服务器

 * Running on http://127.0.0.1:8888
```

### 3. 使用 Tampermonkey 脚本

1. 确保 Tampermonkey 已安装 `enetedu.js` 脚本
2. 访问目标网站（如 `onlinenew.enetedu.com`）
3. 脚本会自动将 `.ts` 文件请求重定向到本地服务器

## 工作原理

### HLS 播放原理

HLS (HTTP Live Streaming) 是一种流媒体协议：

1. **播放列表**: 浏览器首先加载 `.m3u8` 播放列表文件
2. **TS 片段**: 列表中包含多个 `.ts` 视频片段的 URL，每个片段代表一段时间（如 0-10s）
3. **顺序播放**: 播放器按顺序下载并播放这些片段，形成连续视频
4. **时间轴**: 每个片段都有时间标记，播放器据此更新进度

### 我们的优化策略

```
原始流程（高流量）:
浏览器 -> CDN服务器 -> 下载实际 TS 文件
   ↓         ↓
video_0-10s.ts    (500KB)  }
video_10-20s.ts   (500KB)  } 总计：数十MB
video_20-30s.ts   (500KB)  }
   ...                     }

优化后（低流量）:
浏览器 -> 本地代理 (127.0.0.1:8888) -> 返回固定的 1 秒短视频
   ↓         ↓
所有请求 -> small-1seconds.ts (138KB)
   ↓
播放器认为在正常播放
时间轴正常推进
进度正常上报
```

**关键优势**:

- **1秒短视频**: 使用 `small-1seconds.ts` (138KB)，比完整视频更合理
- **时间片段适配**: 无论请求哪个时间段，都返回这个 1 秒片段
- **播放器兼容**: 完美兼容 `aliplayer-hls-min.js` 等 HLS 播放器
- **流量极低**: 无论视频多长，总流量 = 请求次数 × 138KB

## 文件说明

- `ts_proxy_server.py`: Flask 代理服务器脚本
- `small-1seconds.ts`: 1 秒短视频片段（约 138KB，推荐）
- `example.ts`: 完整 TS 视频文件（约 800KB，备用）
- `requirements.txt`: Python 依赖列表
- `enetedu.js`: Tampermonkey 用户脚本

**TS 文件选择策略**:
服务器会自动优先使用 `small-1seconds.ts`，如果不存在则使用 `example.ts`

## 常见问题

### Q: 为什么需要启动本地服务器？

A: 直接在 JavaScript 中嵌入 800KB+ 的 Base64 数据会让脚本文件过大，不利于维护和更新。使用本地服务器可以灵活管理 TS 文件。

### Q: 服务器必须一直运行吗？

A: 是的，只要使用脚本就需要保持服务器运行。可以设置为开机自启动。

### Q: 可以更换 TS 文件吗？

A: 可以。推荐使用 1 秒左右的短视频片段：

- 替换 `small-1seconds.ts` 文件
- 或者放置 `example.ts` 文件
- 服务器会自动选择可用的文件

### Q: 服务器端口可以修改吗？

A: 可以修改 `ts_proxy_server.py` 中的端口号（默认 8888），同时需要修改 `enetedu.js` 中的 `LOCAL_TS_PROXY` 地址。

### Q: 会不会影响视频学习进度上报？

A: 不会。脚本仍然会正常上报学习进度，只是视频内容被替换了。

## 技术细节

- **Flask**: 轻量级 Python Web 框架
- **CORS**: 允许跨域请求，确保浏览器可以访问本地服务
- **MIME Type**: 返回正确的 `video/mp2t` 类型
- **XHR & Fetch 拦截**: 同时拦截两种常见的 HTTP 请求方式

## 更新记录

### v0.6.4.0 (当前版本)

- 采用本地 Flask 服务器方案
- 优先使用 1 秒短视频片段（`small-1seconds.ts`，138KB）
- 智能解析 TS 文件名中的时间片段信息
- 完美适配 HLS 播放器（如 `aliplayer-hls-min.js`）
- 移除大量内嵌 Base64 数据，脚本更轻量

### v0.6.3.x

- 使用模拟 32 字节 TS 数据
- 直接在脚本中处理拦截

## 许可证

MIT License
