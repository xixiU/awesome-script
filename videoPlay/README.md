# HTML5 视频播放工具

一个功能强大的视频播放增强脚本，为网页视频播放器添加丰富的快捷键和功能。

## ✨ 主要功能

### 🤖 智能检测（v2.1 新特性）

- **自动识别视频页面**：无需手动配置，自动检测是否有 H5 播放器
- **零性能损耗**：在非视频页面不会启动，节省系统资源
- **通用兼容性**：自动支持所有包含 HTML5 视频的网站
- **智能三层检测**：快速响应已知网站，智能检测未知网站

### 🌍 实时字幕翻译（新功能）

- **实时语音识别**：使用 faster-whisper 进行高效语音转文字
- **多语言翻译**：支持多种语言互译（中英日韩法德西俄等）
- **美观字幕显示**：自定义样式、位置、大小
- **便捷控制面板**：一键启停，实时配置
- **本地处理**：保护隐私，数据不上传

### 🎬 视频控制

- **播放速度调节**：自由调整视频播放速度（0.1x - 16x）
- **精确帧控制**：逐帧前进/后退，方便精确定位
- **快进/快退**：支持 5 秒和 20 秒快速跳转
- **音量控制**：精确的音量调节

### 📸 高级功能

- **视频截图**：一键截取当前画面并保存为 PNG
- **画中画模式**：支持浮窗播放
- **视频缓存**：可选择缓存整个视频
- **万能网页全屏**：适配各种播放器的全屏功能

### 🌐 支持的网站

**v2.1 智能检测：自动支持所有包含 HTML5 视频的网站！**

脚本会自动识别和适配任何包含 `<video>` 标签的网页，无需手动添加网站支持。

#### 已优化适配的主流网站

以下网站经过特别优化，会快速启用脚本：

**国内视频网站：**

- 哔哩哔哩（bilibili）⭐
- 腾讯视频（QQ）
- 优酷、土豆
- 爱奇艺
- 西瓜视频
- A站（AcFun）
- 芒果TV
- 咪咕视频
- 搜狐视频
- 网易云课堂
- 抖音

**国际视频网站：**

- **YouTube** ⭐（已修复 Trusted Types 兼容性）
- TED
- Twitch

**直播平台：**

- 斗鱼
- 虎牙
- YY直播

**自动兼容：**

- ✅ 所有新兴视频网站
- ✅ 个人网站的视频页面
- ✅ 社交媒体的视频内容
- ✅ 在线教育平台
- ✅ 新闻网站的视频播放器

## ⌨️ 快捷键说明

### 基础控制

| 快捷键 | 功能 | 备注 |
|--------|------|------|
| **空格** | 暂停/播放 | YouTube 除外 |
| **← →** | 快退/快进 5 秒 | |
| **Shift + ← →** | 快退/快进 20 秒 | |
| **↑ ↓** | 增加/减少音量 | |
| **Enter** | 切换全屏 | |
| **Shift + Enter** | 切换网页全屏 | |
| **ESC** | 退出全屏 | |

### 播放速度

| 快捷键 | 功能 | YouTube |
|--------|------|---------|
| **C 键** | 加速 0.1 倍 | **V 键** |
| **X 键** | 减速 0.1 倍 | X 键 |
| **Z 键** | 切换加速状态 | Z 键 |

> 💡 抖音使用：A 键切换速度，S 键减速，V 键加速

### 帧控制

| 快捷键 | 功能 | YouTube |
|--------|------|---------|
| **D 键** | 上一帧 | D 键 |
| **F 键** | 下一帧 | **E 键** |

### 高级功能

| 快捷键 | 功能 |
|--------|------|
| **P 键** | 视频截图 |
| **I 键** | 切换画中画模式 |
| **M 键** | 开始/停止缓存视频 |
| **S 键** | 开启/关闭实时字幕翻译 🆕 |
| **N 键** | 播放下一集 |
| **鼠标中键** | 快进 5 秒 |
| **双击视频** | 切换网页全屏 |

## 🚀 安装使用

### 1. 安装油猴（Tampermonkey）

首先需要安装浏览器扩展：

- [Chrome/Edge](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo)
- [Firefox](https://addons.mozilla.org/firefox/addon/tampermonkey/)

### 2. 安装脚本

1. 打开油猴管理面板
2. 点击"新建脚本"
3. 复制 `html5videoPlay.js` 的全部内容
4. 粘贴并保存

### 3. 刷新网页

访问支持的视频网站，脚本会自动激活。

## 🌍 字幕翻译功能（可选）

如果需要实时字幕识别和翻译功能：

### 启动后端服务

```bash
cd subtitle_backend
./start.sh
```

等待服务启动成功后，会显示：

```
服务地址: http://localhost:8765
```

### 安装字幕脚本

1. 打开 Tampermonkey 管理面板
2. 创建新脚本
3. 复制 `subtitle_module.js` 的内容并保存

### 使用字幕功能

1. 访问视频网站并播放视频
2. 在页面右上角找到"📝 字幕控制"面板
3. 点击"启动字幕"开始识别
4. 点击"配置"可以修改后端地址和目标语言

**📖 详细使用指南：** 查看 [SUBTITLE_GUIDE.md](./SUBTITLE_GUIDE.md)

## 🔧 配置选项

点击油猴图标 → 选择此脚本，可以看到以下选项：

- **√ 记忆播放速度**：自动记住你上次设置的播放速度
- **脚本功能快捷键表**：查看完整的快捷键列表

## 📝 特别说明

### YouTube 适配

由于 YouTube 使用了 Trusted Types 安全策略，我们对脚本进行了特别优化：

- ✅ 所有快捷键正常工作
- ✅ 速度调节使用 V/X/Z 键
- ✅ 下一帧使用 E 键
- ✅ 没有控制台错误

详细技术说明请查看 [YOUTUBE_FIX.md](./YOUTUBE_FIX.md)

### 视频缓存功能

使用 M 键缓存视频时：

- 确认 = 缓存整个视频
- 取消 = 按默认缓冲区大小缓存

💡 直接的媒体类型（如 MP4）无法缓存，只对流媒体有效。

### Chrome 媒体缓存设置

可以通过启动参数增加媒体缓存大小到 840MB：

## 🐛 问题排查

### 脚本未启动

如果在视频网站上脚本没有工作：

1. **打开浏览器控制台**（按 F12）
2. 查看是否有以下日志：
   - `[HTML5视频工具] 检测到 X 个视频元素，启用脚本` - 表示正常启用
   - `[HTML5视频工具] 未检测到视频元素，不启用脚本` - 页面没有视频
   - `[HTML5视频工具] 当前页面不需要启用脚本` - 在排除列表中

3. **可能的原因：**
   - 页面使用了非标准的视频播放器（如 Flash）
   - 视频元素加载时间超过 10 秒
   - 页面在排除列表中

4. **解决方法：**
   - 刷新页面重试
   - 等待视频完全加载后再操作
   - 在控制台查看详细日志

### 快捷键不工作

1. 检查是否有输入框处于焦点状态
2. 确认脚本已正常启动（查看控制台日志）
3. 刷新页面重试
4. 查看浏览器控制台是否有错误

### YouTube 相关问题

如果在 YouTube 上遇到问题：

1. 确保使用最新版本的脚本
2. 清除浏览器缓存
3. 禁用其他可能冲突的脚本
4. 查看控制台（F12）是否有 Trusted Types 错误

### 速度调节无效

某些网站（如 QQ、百度）可能限制了速度调节功能。

## 💻 开发信息

- **版本**：2.2.0
- **作者**：基于 Greasyfork 用户 7036 的脚本改进
- **许可**：MIT License
- **主页**：<https://bbs.kafan.cn/thread-2093014-1-1.html>

## 📋 更新日志 (Changelog)

### v2.2.0 (2024-11-14)

#### 🌍 实时字幕翻译功能（重大更新）

**新增功能：**

- ✅ 集成实时字幕识别和翻译系统
- ✅ 基于 faster-whisper 的语音识别
- ✅ 支持 12+ 种语言翻译
- ✅ 智能控制栏按钮（自动适配多种播放器）
- ✅ 浮动按钮（兼容方案）
- ✅ S 键快捷键控制

**技术实现：**

- Python 后端服务（FastAPI + faster-whisper）
- MediaRecorder API 音频捕获
- 实时字幕显示UI
- 配置持久化存储

**支持的播放器：**

- Bilibili、YouTube、西瓜视频、抖音
- DPlayer、Video.js、阿里播放器
- 所有通用 HTML5 播放器

#### 🔧 配置管理优化

**集成 ConfigManager：**

- ✅ 使用统一的配置管理模块
- ✅ 完整的国际化支持（中英意三语）
- ✅ 简化菜单注册逻辑（代码减少 60%）
- ✅ 统一的配置界面

**增强的 ConfigManager 功能：**

- 国际化文本支持 `t(key, defaultText)`
- 国际化菜单注册 `registerMenuCommand(textKey, callback, icon)`
- 简化对话框创建 `createSimpleDialog(fields, onSave)`
- 切换型菜单 `createToggleMenu(titleKey, saveKey, defaultValue)`

**向后兼容：**

- ✅ 不影响其他使用 ConfigManager 的脚本
- ✅ 所有原有功能保持不变
- ✅ 可选的功能增强

#### 📝 其他改进

- 更新多语言帮助文本（添加字幕功能说明）
- 优化菜单结构和组织
- 改进代码可读性和注释
- 完善错误处理机制

### v2.1.0 (2024-11-14)

#### 🎯 重大改进：智能检测机制

**优化前的问题：**

- 需要手动为每个视频网站添加 `@match` 规则
- 脚本会在所有明确列出的网站上运行，即使页面没有视频
- 维护成本高，新网站需要手动添加匹配规则

**优化后的解决方案：**

- ✅ 改用通用匹配规则 `@match *://*/*`
- ✅ 添加智能检测机制，自动判断页面是否有 H5 播放器
- ✅ 三层检测策略，确保准确性和性能
- ✅ 自动支持所有包含 HTML5 视频的网站

#### 🔍 智能检测工作原理

脚本现在使用三层检测策略：

1. **排除列表检测**（最快）
   - 排除搜索引擎、邮箱、代码托管等明确不需要的网站
   - 避免在这些网站上进行不必要的检测

2. **已知网站检测**（快速路径）
   - 识别常见视频网站域名：YouTube, B站, 优酷, 爱奇艺等
   - 这些网站直接启用，无需等待

3. **URL 路径检测**
   - 检查 URL 是否包含视频相关关键词：`/video`, `/play`, `/watch`, `/live` 等
   - 适用于未知的新视频网站

4. **DOM 元素检测**（延迟检测）
   - 如果前面都没匹配，检查页面是否有 `<video>` 标签
   - 使用 MutationObserver 监听动态加载的视频
   - 最多等待 10 秒，避免长时间占用资源

#### 🚀 性能优化

- **减少内存占用**：不在无关页面启动脚本
- **降低 CPU 使用**：避免在非视频页面进行不必要的监听
- **快速响应**：已知网站立即启用，未知网站智能检测

#### 🐛 Bug 修复

**YouTube Trusted Types 兼容性修复：**

- ✅ 修复 YouTube 快捷键失效问题
- ✅ 修复提示框无法显示的问题
- ✅ 解决 `innerHTML` 的 Trusted Types 限制
- ✅ 优化快捷键映射：V=加速, X=减速, Z=切换, E=下一帧

**技术实现：**

- 添加 Trusted Types 策略创建
- 重构提示框创建逻辑，使用 `createElement` 替代 `innerHTML`
- 添加安全的 HTML 设置辅助函数

#### 📝 其他改进

- 添加详细的控制台日志，方便调试
- 改进错误处理机制
- 优化菜单命令注册

### v2.0.2 (之前版本)

- 支持多个主流视频网站
- 提供丰富的快捷键功能
- 画中画、截图、缓存等高级功能

## 🙏 致谢

- 感谢 Dario Costa 提供的英语和意大利语翻译
- 感谢所有贡献者和用户的反馈

## 📮 反馈

如果遇到问题或有建议，欢迎：

- 在浏览器控制台查看详细日志
- 提供具体的错误信息和复现步骤
- 说明浏览器版本和操作系统

---

**享受更好的视频观看体验！** 🎉
