# Dify网页智能总结 - 油猴脚本

## 📝 简介

这是一个智能网页总结工具，支持使用 Dify 工作流或 Chrome 内置 Gemini AI 对网页内容进行总结。可以在任何网页上一键调用 AI 对当前页面内容进行智能分析。脚本采用智能算法自动提取网页正文，适用于各类知识型网站。

## ✨ 特性

- 🤖 **双 AI 引擎支持**：
  - **Dify 工作流**：支持自定义工作流，灵活配置 AI 处理逻辑
  - **Chrome Gemini AI**：使用 Chrome 浏览器内置的 Gemini Nano 模型，无需配置 API，本地运行更快速
  - 一键切换，满足不同使用场景

- ✂️ **双模式总结**：
  - **全文总结**：点击按钮总结整篇文章
  - **选中文本总结**：选中网页任意部分后点击按钮，只总结选中的内容
  - 智能识别，自动适配，按钮会实时显示当前模式

- 🎯 **智能内容提取**：采用多策略智能算法，自动识别并提取网页正文
  - 支持常见的文章网站（博客、新闻、技术文档等）
  - 自动过滤广告、导航栏、侧边栏等无关内容
  - 使用文本密度算法精准定位主要内容区域

- 🚀 **一键总结**：点击浮动按钮即可调用 AI 进行内容总结

- 💡 **美观的UI**：
  - 现代化的渐变色设计
  - 流畅的动画效果
  - 响应式结果展示面板

- ⚙️ **代码与配置分离**：
  - 配置信息存储在浏览器本地，与脚本代码完全独立
  - 升级脚本时不会丢失配置
  - 可视化配置界面，操作简单直观
  - 实时状态提示，一目了然
  - 支持配置验证和错误提示

## 📦 安装

### 前置要求

#### 必需

1. 安装浏览器扩展 [Tampermonkey](https://www.tampermonkey.net/)
   - Chrome: [Chrome Web Store](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojobhflfapmlkmbgj)
   - Firefox: [Firefox Add-ons](https://addons.mozilla.org/en-US/firefox/addon/tampermonkey/)
   - Edge: [Edge Add-ons](https://microsoftedge.microsoft.com/addons/detail/tampermonkey/iikmkjmpaadaobahmlepeloendndfphd)

#### AI 提供商配置（二选一）

##### 选项 1: 使用 Chrome Gemini AI（推荐新手）

- **Chrome 版本**: >= 125
- **Gemini Nano 模型**: 需要下载
  1. 访问 `chrome://components`
  2. 找到 "Optimization Guide On Device Model"
  3. 确认版本号 >= 2024.5.21.1031
  4. 如未安装，点击 "Check for update" 下载
- **优势**: 无需配置 API，本地运行，响应快速，免费

##### 选项 2: 使用 Dify 工作流（适合进阶用户）

- 登录你的Dify平台
- 创建一个工作流，包含以下输入参数：
  - `newsUrl` (文本): 网页URL
  - `newsContent` (文本): 网页正文内容
- 获取工作流的API地址和API Key
- **优势**: 自定义工作流，灵活配置 AI 处理逻辑

### 安装步骤

1. 点击Tampermonkey图标 → 管理面板
2. 点击"+"号创建新脚本
3. 复制 `dify_web_summarizer.js` 的全部内容
4. 粘贴到编辑器中，保存（Ctrl+S 或 Cmd+S）

## ⚙️ 配置

### 首次使用配置

**特色：代码与配置完全分离** ✨

脚本采用现代化的配置管理方式，所有配置信息都存储在浏览器本地，与脚本代码完全分离。这意味着：

- ✅ 升级脚本时不会丢失配置
- ✅ 配置信息安全存储在本地
- ✅ 美观的可视化配置界面
- ✅ 实时配置状态提示

#### 配置步骤

1. **打开任意网页**
2. **点击右下角的 ⚙️ 齿轮图标**
3. **在弹出的配置面板中填写**：
   - **Dify 工作流 API 地址**：例如 `https://api.dify.ai/v1/workflows/run`
   - **Dify API Key**：你的API密钥（以 `app-` 开头）
   - 面板会显示每个配置项的状态（已配置/未配置）
4. **点击"保存配置"按钮**
5. **看到"✓ 配置已成功保存！"提示**后即可使用

#### 配置特点

- 🔒 **安全存储**：配置信息使用 GM_setValue 存储在浏览器本地，安全可靠
- 🎨 **美观界面**：现代化的表单设计，清晰的状态提示
- ✓ **输入验证**：自动验证 URL 格式和必填字段
- ⌨️ **快捷操作**：支持 Enter 键快速保存，Esc 键取消
- 🔄 **易于修改**：随时可以重新打开设置面板修改配置

### Dify工作流配置示例

在Dify中创建工作流时，建议包含以下节点：

```yaml
输入参数:
  - newsUrl: 网页地址
  - newsContent: 网页正文

处理流程:
  1. 使用LLM节点分析newsContent
  2. 生成总结（可以包含：关键要点、主要观点、总结等）
  3. 输出结果到 outputs.text 或 outputs.result

输出格式:
  - text: 总结结果（支持Markdown格式）
```

## 🚀 使用方法

### 方式一：全文总结

1. **访问任意网页**
   - 打开你想要总结的文章、博客或新闻页面

2. **点击总结按钮**
   - 点击页面右下角的 **📝 AI总结** 按钮

3. **等待处理**
   - 脚本会自动提取网页正文
   - 调用 AI 进行分析
   - 处理时间取决于文章长度和 AI 响应速度

4. **查看结果**
   - 总结结果会在弹出面板中显示
   - 面板标题会显示"📝 AI总结结果（全文）"
   - 支持 Markdown 格式渲染
   - 点击关闭按钮或遮罩层关闭面板

### 方式二：选中文本总结 ✨ 新功能

1. **选中你关心的内容**
   - 用鼠标拖动选中网页中的任意文本
   - 选中的文本需要至少 50 个字符

2. **观察按钮变化**
   - 按钮图标会从 📝 变为 ✂️
   - 按钮文字会从"AI总结"变为"总结选中"
   - 悬停查看提示会显示选中文本的字符数

3. **点击总结按钮**
   - 点击按钮，AI 将只对你选中的文本进行总结
   - 非常适合对长文章中的特定段落进行深度分析

4. **查看结果**
   - 总结结果面板标题会显示"📝 AI总结结果（选中文本）"
   - 总结完成后会自动清除文本选择

### 快捷操作

- **拖动面板**：可以拖动面板标题栏移动位置
- **全屏显示**：点击 ⤢ 按钮全屏查看总结结果
- **复制结果**：点击 📋 按钮快速复制总结内容
- **拖动按钮**：长按并拖动按钮可以调整位置，松开后自动贴边

## 🔧 智能内容提取原理

脚本采用三层策略确保准确提取网页正文：

### 策略1: 常见选择器匹配

尝试使用以下选择器：

- `article`, `main`, `[role="main"]`
- `.article-content`, `.post-content`, `.entry-content`
- `.markdown-body`, `.news-content`, `.detail-content`
- 等等...

### 策略2: 文本密度算法

当常见选择器失效时，使用智能算法：

- 计算每个容器的文本长度
- 分析链接密度（链接少的区域更可能是正文）
- 检测标点符号密度（正文通常有合理的标点密度）
- 统计段落数量（正文通常包含多个段落）
- 综合评分并选择最佳候选区域

### 策略3: Body回退

当以上策略都失败时，从整个body提取并清理内容

### 内容清理

- 自动移除导航栏、侧边栏、广告、评论区等
- 规范化空白字符和换行
- 保留段落结构

## 🎨 自定义

### 修改按钮位置

编辑脚本中的 `CONFIG` 对象：

```javascript
const CONFIG = {
    buttonPosition: {
        bottom: '80px',  // 距离底部的距离
        right: '20px'    // 距离右侧的距离
    }
};
```

### 修改样式

在脚本的 `styles` 部分自定义CSS样式，可以修改：

- 按钮颜色和样式
- 面板大小和位置
- 动画效果
- 字体和排版

### 添加自定义选择器

在 `ContentExtractor` 类的 `contentSelectors` 数组中添加更多选择器：

```javascript
this.contentSelectors = [
    'article',
    'main',
    '.your-custom-selector',  // 添加你的选择器
    // ...
];
```

## 🐛 故障排除

### 问题1: 点击按钮无反应

- 检查控制台是否有错误信息（F12打开开发者工具）
- 确认已正确配置Dify API地址和密钥
- 检查网络连接

### 问题2: 提取的内容不准确

- 打开控制台查看提取的内容（会有日志输出）
- 可以手动添加该网站的特定选择器
- 反馈问题，帮助改进算法

### 问题3: API调用失败

- 确认Dify API地址正确
- 确认API Key有效且有足够的调用额度
- 检查Dify工作流的输入输出参数配置
- 查看控制台错误信息获取详细原因

### 问题4: 显示格式错误

- Dify工作流返回的数据结构可能需要调整
- 编辑脚本中的 `DifyAPI.summarize` 方法
- 调整响应数据的解析路径

## 📝 Dify响应格式说明

脚本默认尝试从以下路径获取结果：

1. `data.data.outputs.text`
2. `data.data.outputs.result`
3. `data.answer`
4. 完整的JSON响应

如果你的Dify工作流返回格式不同，请修改脚本中的这部分代码：

```javascript
const result = data.data?.outputs?.text || 
               data.data?.outputs?.result || 
               data.answer || 
               JSON.stringify(data, null, 2);
```

## 📝 更新记录

### v1.5.2 (2025-11-07)

- 🐛 修复全屏模式下按钮不隐藏的bug
  - 修复文本选择监听器会覆盖全屏隐藏状态的问题
  - 现在全屏模式下按钮会正确隐藏

### v1.5.1 (2025-11-07)

- ✨ 新增选中文本总结功能
  - 支持对网页任意选中的文本进行 AI 总结
  - 按钮会实时响应文本选择，自动切换图标和文字提示
  - 选中文本需至少 50 个字符
  - 总结完成后自动清除选择
- 🎨 优化用户体验
  - 按钮悬停提示显示选中文本字符数
  - 结果面板标题区分"全文"和"选中文本"模式
  - 智能判断用户意图，无需额外配置

### v1.5.0 (2025-11-07)

- ✨ 新增 Chrome Gemini AI 支持
  - 支持使用 Chrome 内置的 Gemini Nano 模型
  - 本地运行，无需配置 API，响应更快
- 🎨 新增结果面板交互功能
  - 支持拖动面板调整位置
  - 支持全屏显示总结结果
- ⚙️ 优化配置界面
  - 新增 AI 提供商选择器
  - 根据选择的提供商动态显示/隐藏配置项

### v1.4.x

- 初始版本功能
  - 智能内容提取
  - Dify 工作流集成
  - 可视化配置界面
  - 浮动按钮与结果面板

## 📄 许可证

MIT License - 可自由使用和修改

## 🤝 贡献

欢迎提交问题和改进建议！

## 📮 反馈

如有问题或建议，请通过以下方式反馈：

- 提交Issue
- 发送邮件
- 或其他联系方式

---

**享受智能阅读体验！** 📚✨
