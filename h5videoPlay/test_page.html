<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—å¹•åŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert h3 {
            margin-top: 0;
        }

        .video-container {
            background: #000;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        video {
            width: 100%;
            max-width: 640px;
            display: block;
            margin: 0 auto;
        }

        .info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .info h3 {
            margin-top: 0;
            color: #2196F3;
        }

        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #1976D2;
        }

        #log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .log-error {
            color: #f44;
        }

        .log-success {
            color: #4f4;
        }

        .log-warn {
            color: #fa0;
        }

        ol {
            line-height: 1.8;
        }

        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>

<body>
    <h1>ğŸ¬ HTML5 è§†é¢‘å­—å¹•åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>

    <div class="alert">
        <h3>âš ï¸ é‡è¦è¯´æ˜</h3>
        <p><strong>ç”±äºæµè§ˆå™¨ MediaRecorder API çš„é™åˆ¶ï¼Œå­—å¹•åŠŸèƒ½åœ¨ä¸»æµè§†é¢‘ç½‘ç«™ï¼ˆBç«™ã€YouTubeç­‰ï¼‰æš‚æ—¶æ— æ³•ä½¿ç”¨ã€‚</strong></p>
        <p>æœ¬æµ‹è¯•é¡µé¢ä½¿ç”¨æ™®é€š HTML5 è§†é¢‘ï¼Œå¯ä»¥éªŒè¯å­—å¹•åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
    </div>

    <div class="info">
        <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
        <ol>
            <li>ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ï¼š<code>cd subtitle_backend && ./start.sh</code></li>
            <li>ç¡®ä¿å·²å®‰è£…æ²¹çŒ´è„šæœ¬ï¼š<code>html5videoPlay.js</code></li>
            <li>ç‚¹å‡»ä¸‹æ–¹è§†é¢‘çš„æ’­æ”¾æŒ‰é’®</li>
            <li>æŒ‰ <strong>S é”®</strong> æˆ–ç‚¹å‡»å³ä¸‹è§’æµ®åŠ¨æŒ‰é’®å¼€å¯å­—å¹•</li>
            <li>è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼ˆF12ï¼‰å’Œå­—å¹•æ˜¾ç¤º</li>
            <li>ä½¿ç”¨ä¸‹é¢çš„æµ‹è¯•æŒ‰é’®éªŒè¯å„é¡¹åŠŸèƒ½</li>
        </ol>
    </div>

    <div class="video-container">
        <video id="test-video" controls crossorigin="anonymous">
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ video æ ‡ç­¾ã€‚
        </video>
    </div>

    <div class="info">
        <h3>ğŸ”§ æµ‹è¯•å·¥å…·</h3>
        <button onclick="testVideoInfo()">1. æ£€æŸ¥è§†é¢‘ä¿¡æ¯</button>
        <button onclick="testCaptureStream()">2. æµ‹è¯•éŸ³é¢‘æ•è·</button>
        <button onclick="testMediaRecorder()">3. æµ‹è¯• MediaRecorder</button>
        <button onclick="testBackend()">4. æµ‹è¯•åç«¯è¿æ¥</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="info">
        <h3>ğŸ“Š æµ‹è¯•æ—¥å¿—</h3>
        <div id="log"></div>
    </div>

    <script>
        const logEl = document.getElementById('log');

        function addLog(message, type = 'info') {
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            line.innerHTML = `<span style="color:#888">[${time}]</span> ${message}`;
            if (type === 'error') line.className = 'log-error';
            if (type === 'success') line.className = 'log-success';
            if (type === 'warn') line.className = 'log-warn';
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${time}] ${message}`);
        }

        function testVideoInfo() {
            const video = document.getElementById('test-video');
            addLog('========== è§†é¢‘ä¿¡æ¯ ==========', 'info');
            addLog(`è§†é¢‘åœ°å€: ${video.currentSrc || video.src}`);

            const videoSrc = video.currentSrc || video.src;
            if (videoSrc) {
                const videoOrigin = new URL(videoSrc).origin;
                const pageOrigin = location.origin;
                addLog(`è§†é¢‘åŸŸå: ${videoOrigin}`);
                addLog(`é¡µé¢åŸŸå: ${pageOrigin}`);

                const isCrossOrigin = videoOrigin !== pageOrigin;
                addLog(`æ˜¯å¦è·¨åŸŸ: ${isCrossOrigin ? 'âŒ æ˜¯' : 'âœ… å¦'}`, isCrossOrigin ? 'error' : 'success');
                addLog(`æ˜¯å¦ Blob URL: ${videoSrc.startsWith('blob:') ? 'æ˜¯' : 'å¦'}`);
            }

            addLog(`æ’­æ”¾çŠ¶æ€: ${!video.paused ? 'âœ… æ’­æ”¾ä¸­' : 'âŒ å·²æš‚åœ'}`, !video.paused ? 'success' : 'error');
            addLog(`éŸ³é‡: ${video.volume}, é™éŸ³: ${video.muted ? 'æ˜¯' : 'å¦'}`);
            addLog(`readyState: ${video.readyState}${video.readyState >= 3 ? ' âœ…' : ' âš ï¸'}`);
            addLog(`crossOrigin å±æ€§: ${video.crossOrigin || 'æœªè®¾ç½®'}`);
        }

        function testCaptureStream() {
            const video = document.getElementById('test-video');
            addLog('========== æµ‹è¯•éŸ³é¢‘æ•è· ==========', 'info');

            try {
                if (!video.captureStream) {
                    throw new Error('ä¸æ”¯æŒ captureStream API');
                }

                const stream = video.captureStream();
                addLog('âœ… captureStream æˆåŠŸ', 'success');

                const audioTracks = stream.getAudioTracks();
                addLog(`âœ… éŸ³è½¨æ•°é‡: ${audioTracks.length}`, audioTracks.length > 0 ? 'success' : 'error');

                if (audioTracks.length > 0) {
                    audioTracks.forEach((track, i) => {
                        addLog(`  éŸ³è½¨ ${i}: label="${track.label}", enabled=${track.enabled}, muted=${track.muted}, state=${track.readyState}`);
                    });
                } else {
                    addLog('âŒ æ²¡æœ‰éŸ³è½¨', 'error');
                }
            } catch (error) {
                addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function testMediaRecorder() {
            const video = document.getElementById('test-video');
            addLog('========== æµ‹è¯• MediaRecorder ==========', 'info');

            try {
                const stream = video.captureStream();
                const recorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                addLog('âœ… MediaRecorder åˆ›å»ºæˆåŠŸ', 'success');
                addLog(`MIME ç±»å‹: ${recorder.mimeType}`);
                addLog(`çŠ¶æ€: ${recorder.state}`);

                let dataCount = 0;
                let totalSize = 0;

                recorder.ondataavailable = (e) => {
                    dataCount++;
                    totalSize += e.data.size;
                    addLog(`ğŸ“Š æ¥æ”¶æ•°æ® #${dataCount}: ${e.data.size} bytes`, 'success');
                };

                recorder.onstop = () => {
                    addLog(`âœ… å½•åˆ¶å®Œæˆï¼Œå…± ${dataCount} ä¸ªæ•°æ®å—ï¼Œæ€»å¤§å°: ${(totalSize / 1024).toFixed(2)} KB`, 'success');
                    if (dataCount === 0) {
                        addLog('âš ï¸ è­¦å‘Šï¼šæ²¡æœ‰æ¥æ”¶åˆ°éŸ³é¢‘æ•°æ®ï¼', 'warn');
                    }
                };

                recorder.start(1000); // æ¯ç§’è§¦å‘ä¸€æ¬¡ dataavailable
                addLog('âœ… MediaRecorder å·²å¯åŠ¨ï¼Œå½•åˆ¶ 3 ç§’...', 'success');

                setTimeout(() => {
                    recorder.stop();
                    addLog('âœ… MediaRecorder å·²åœæ­¢', 'success');
                }, 3000);

            } catch (error) {
                addLog(`âŒ é”™è¯¯: ${error.name} - ${error.message}`, 'error');
            }
        }

        async function testBackend() {
            addLog('========== æµ‹è¯•åç«¯æœåŠ¡ ==========', 'info');

            try {
                const response = await fetch('http://localhost:8765/health');
                const data = await response.json();
                addLog('âœ… åç«¯è¿æ¥æˆåŠŸ', 'success');
                addLog(`æœåŠ¡çŠ¶æ€: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                addLog(`âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                addLog('ğŸ’¡ è¯·å¯åŠ¨æœåŠ¡: cd subtitle_backend && ./start.sh', 'warn');
            }
        }

        function clearLog() {
            logEl.innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            addLog('âœ… é¡µé¢åŠ è½½å®Œæˆ', 'success');
            addLog('ğŸ“Œ æç¤ºï¼šæ’­æ”¾è§†é¢‘åï¼ŒæŒ‰ S é”®å¼€å¯å­—å¹•', 'info');
            addLog('ğŸ“Œ æˆ–ç‚¹å‡»å³ä¸‹è§’æµ®åŠ¨æŒ‰é’® ğŸ“', 'info');
        });
    </script>
</body>

</html>