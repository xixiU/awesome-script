# 代码结构说明

## 概述

代码已重构为模块化结构，将UI、音频采集、语音转文字、翻译等功能独立成模块，便于后续优化和维护。

## 目录结构

```
subtitle_backend/
├── ui/                          # UI模块
│   ├── __init__.py
│   └── floating_window.py      # 悬浮窗口UI
├── audio/                       # 音频采集模块
│   ├── __init__.py
│   └── audio_capture.py         # 音频采集器
├── translation/                 # 翻译模块
│   ├── __init__.py
│   └── translator.py           # 文本翻译器
├── models/                      # 语音转文字模型
│   ├── base_model.py           # 模型基类
│   ├── model_manager.py        # 模型管理器
│   ├── whisper_model.py        # Whisper模型
│   └── siliconflow_model.py    # 硅基流动模型
├── stt_service.py              # 语音转文字服务层
├── config_manager.py           # 配置管理器
├── system_audio_subtitle.py    # 主服务文件（整合所有模块）
└── ...
```

## 模块说明

### 1. UI模块 (`ui/`)

**文件**: `ui/floating_window.py`

**功能**:
- 实时字幕显示窗口
- 模型选择下拉框
- 语言选择（源语言/目标语言）
- 延迟显示开关
- 窗口拖拽和调整大小

**主要类**:
- `FloatingWindow`: 悬浮窗口类

**使用示例**:
```python
from ui.floating_window import FloatingWindow

window = FloatingWindow(
    target_lang="zh-CN",
    source_lang="Auto",
    lang_callback=on_lang_change,
    model_callback=on_model_change
)
window.create_window()
```

### 2. 音频采集模块 (`audio/`)

**文件**: `audio/audio_capture.py`

**功能**:
- 从系统音频设备采集音频
- 自动选择音频设备
- 音频数据队列管理
- 支持多平台（Windows/macOS/Linux）

**主要类**:
- `AudioCapture`: 音频采集器

**使用示例**:
```python
from audio.audio_capture import AudioCapture

capture = AudioCapture(sample_rate=16000, chunk_duration=2.0)
if capture.start():
    chunk = capture.get_chunk(timeout=0.5)
    # 处理音频块
```

### 3. 翻译模块 (`translation/`)

**文件**: `translation/translator.py`

**功能**:
- 文本翻译（基于Google Translator）
- 支持同步和异步翻译
- 语言切换
- 自动语言检测

**主要类**:
- `Translator`: 文本翻译器

**使用示例**:
```python
from translation.translator import Translator

translator = Translator(target_lang="zh-CN")
result = translator.translate("Hello, world")

# 异步翻译
def on_complete(text, cost):
    print(f"翻译结果: {text}, 耗时: {cost}s")
translator.translate_async("Hello", on_complete)
```

### 4. 语音转文字服务层 (`stt_service.py`)

**文件**: `stt_service.py`

**功能**:
- 管理语音识别模型
- 模型切换
- 统一的语音转文字接口
- 自动配置模型参数

**主要类**:
- `STTService`: 语音转文字服务

**使用示例**:
```python
from stt_service import STTService

service = STTService()
service.initialize()
text, lang, cost = service.transcribe(audio_data, sample_rate=16000)
```

### 5. 主服务文件 (`system_audio_subtitle.py`)

**文件**: `system_audio_subtitle.py`

**功能**:
- 整合所有模块
- 协调UI、音频采集、语音转文字、翻译
- 音频处理循环
- 文本拼接和翻译逻辑

**主要类**:
- `SystemAudioSubtitleService`: 主服务类

## 模块间关系

```
SystemAudioSubtitleService (主服务)
    ├── FloatingWindow (UI模块)
    │   └── 显示字幕和控制界面
    ├── AudioCapture (音频采集模块)
    │   └── 采集系统音频
    ├── STTService (语音转文字服务)
    │   └── ModelManager
    │       └── BaseSpeechToTextModel
    │           ├── WhisperSTTModel
    │           └── SiliconFlowSTTModel
    └── Translator (翻译模块)
        └── GoogleTranslator
```

## 优化建议

### UI模块优化方向
- 添加主题切换功能
- 支持自定义字体和颜色
- 添加字幕历史记录
- 支持导出字幕文件

### 音频采集模块优化方向
- 支持多设备同时采集
- 添加音频预处理（降噪、增益等）
- 支持音频格式转换
- 添加音频可视化

### 翻译模块优化方向
- 支持多种翻译服务（百度、有道等）
- 添加翻译缓存
- 支持批量翻译
- 添加翻译质量评估

### 语音转文字服务优化方向
- 添加模型性能监控
- 支持模型热切换
- 添加识别结果缓存
- 支持流式识别

## 扩展新功能

### 添加新的UI组件

1. 在 `ui/` 目录下创建新文件
2. 实现UI组件类
3. 在 `FloatingWindow` 中集成

### 添加新的翻译服务

1. 在 `translation/` 目录下创建新文件
2. 实现翻译器类（参考 `translator.py`）
3. 在 `Translator` 中添加支持或创建新的翻译器类

### 添加新的语音识别模型

1. 在 `models/` 目录下创建新文件
2. 继承 `BaseSpeechToTextModel`
3. 在 `ModelManager` 中注册

## 注意事项

1. **线程安全**: UI更新必须通过队列进行，避免跨线程直接操作UI
2. **资源清理**: 各模块都实现了 `cleanup()` 方法，确保资源正确释放
3. **错误处理**: 各模块都有完善的错误处理和日志记录
4. **配置管理**: 模型配置统一由 `ConfigManager` 管理

## 测试建议

1. **单元测试**: 为每个模块编写单元测试
2. **集成测试**: 测试模块间的协作
3. **性能测试**: 测试各模块的性能表现
4. **兼容性测试**: 测试不同平台和设备的兼容性

